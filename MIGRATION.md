# CLI Migration Guide

This guide helps you migrate from the legacy flat command structure to the new nested Commander.js-based CLI.

## Overview

The Cortex CLI has been restructured from flat top-level commands to a nested command architecture. This change improves organization, discoverability, and consistency.

**Key changes:**
- Memory operations are now under `cortex memory <command>`
- Store operations are now under `cortex store <command>`
- The `--global-store` flag has been removed
- New short flags added for convenience (e.g., `-s` for `--store`)
- Help is auto-generated by Commander.js

## Command Mapping

### Memory Operations

| Old Command | New Command |
|-------------|-------------|
| `cortex add <path>` | `cortex memory add <path>` |
| `cortex show <path>` | `cortex memory show <path>` |
| `cortex update <path>` | `cortex memory update <path>` |
| `cortex remove <path>` | `cortex memory remove <path>` |
| `cortex move <from> <to>` | `cortex memory move <from> <to>` |
| `cortex list [category]` | `cortex memory list [category]` |

### Store Operations

| Old Command | New Command |
|-------------|-------------|
| `cortex prune` | `cortex store prune` |
| `cortex reindex` | `cortex store reindex` |

## Removed Features

### `--global-store` Flag

The `--global-store` flag has been removed. Store selection is now handled via:

- The `-s, --store <name>` option on command groups
- Automatic store resolution based on working directory

```bash
# Old (no longer works)
cortex list --global-store

# New
cortex memory list -s default
cortex memory -s default list
```

## New Features

### Short Flags

Common options now have short flag alternatives:

| Long Flag | Short Flag | Description |
|-----------|------------|-------------|
| `--store <name>` | `-s <name>` | Specify named store |
| `--content <text>` | `-c <text>` | Inline content |
| `--file <path>` | `-f <path>` | Read from file |
| `--tags <tags>` | `-t <tags>` | Comma-separated tags |
| `--expires-at <date>` | `-e <date>` | Expiration date |
| `--include-expired` | `-x` | Include expired memories |
| `--format <format>` | `-o <format>` | Output format |

### Store Option Inheritance

The `--store` option can be specified on either the command group or the subcommand:

```bash
# Both work identically
cortex memory -s my-store list
cortex memory list -s my-store
```

### Improved Help

Help is now auto-generated by Commander.js. Access it at any level:

```bash
cortex --help              # Top-level help
cortex memory --help       # Memory command group help
cortex memory add --help   # Specific command help
cortex store --help        # Store command group help
```

### Consistent Error Handling

Errors now use Commander.js exception handling:

- Invalid arguments show usage hints
- Missing required options are caught before execution
- Exit codes are consistent (0 for success, 1 for errors)

## Common Operations

### Adding a Memory

```bash
# Old
cortex add project/notes --content "My notes"

# New
cortex memory add project/notes --content "My notes"
cortex memory add project/notes -c "My notes"           # short flag
cortex memory add project/notes -f ./notes.md           # from file
echo "My notes" | cortex memory add project/notes       # from stdin
```

### Listing Memories

```bash
# Old
cortex list
cortex list project/cortex

# New
cortex memory list
cortex memory list project/cortex
cortex memory list -o json                              # JSON output
cortex memory list -x                                   # include expired
```

### Showing a Memory

```bash
# Old
cortex show project/notes

# New
cortex memory show project/notes
cortex memory show project/notes -o json
```

### Updating a Memory

```bash
# Old
cortex update project/notes --content "Updated"

# New
cortex memory update project/notes --content "Updated"
cortex memory update project/notes -c "Updated"
```

### Moving a Memory

```bash
# Old
cortex move project/old-name project/new-name

# New
cortex memory move project/old-name project/new-name
```

### Removing a Memory

```bash
# Old
cortex remove project/notes

# New
cortex memory remove project/notes
```

### Store Maintenance

```bash
# Old
cortex prune
cortex reindex

# New
cortex store prune
cortex store prune -s my-store                          # specific store
cortex store reindex
cortex store reindex -s my-store
```

### Working with Stores

```bash
cortex store list                      # List all stores
cortex store add <name> <path>         # Register a store
cortex store remove <name>             # Unregister a store
cortex store init [path]               # Initialize new store
```

## Backwards Compatibility

**This is a clean break.** The old flat command structure is no longer supported.

If you have scripts using the old commands, update them to the new nested structure. A simple find-and-replace should handle most cases:

| Find | Replace |
|------|---------|
| `cortex add ` | `cortex memory add ` |
| `cortex show ` | `cortex memory show ` |
| `cortex update ` | `cortex memory update ` |
| `cortex remove ` | `cortex memory remove ` |
| `cortex move ` | `cortex memory move ` |
| `cortex list` | `cortex memory list` |
| `cortex prune` | `cortex store prune` |
| `cortex reindex` | `cortex store reindex` |

## Quick Reference

```bash
# Memory operations
cortex memory add <path> -c <content>    # Create memory
cortex memory show <path>                # Display memory
cortex memory update <path> -c <content> # Update memory
cortex memory remove <path>              # Delete memory
cortex memory move <from> <to>           # Rename/move memory
cortex memory list [category]            # List memories

# Store operations
cortex store list                        # List stores
cortex store add <name> <path>           # Register store
cortex store remove <name>               # Unregister store
cortex store init [path]                 # Initialize store
cortex store prune                       # Remove expired memories
cortex store reindex                     # Rebuild indexes

# Help
cortex --help
cortex memory --help
cortex store --help
```
