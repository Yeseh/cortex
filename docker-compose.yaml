# Cortex MCP Server - Docker Compose Configuration
#
# Production deployment configuration for the Cortex MCP server.
# For local development, copy docker-compose.override.yaml.example to
# docker-compose.override.yaml and customize as needed.
#
# Usage:
#   docker compose up -d          # Start in detached mode
#   docker compose logs -f        # View logs
#   docker compose down           # Stop and remove containers
#   docker compose down -v        # Stop and remove containers + volumes

services:
    cortex:
        build:
            context: .
            dockerfile: Dockerfile
        image: cortex-mcp:latest
        container_name: cortex-mcp
        restart: unless-stopped

        # Port mapping - use CORTEX_PORT env var to customize
        ports:
            - '${CORTEX_PORT:-3000}:3000'

        # Named volume for persistent data storage
        volumes:
            - cortex-data:/data

        # Environment configuration
        environment:
            - CORTEX_DATA_PATH=/data
            - CORTEX_PORT=3000
            - CORTEX_HOST=0.0.0.0
            - CORTEX_DEFAULT_STORE=${CORTEX_DEFAULT_STORE:-default}
            - CORTEX_LOG_LEVEL=${CORTEX_LOG_LEVEL:-info}
            - CORTEX_OUTPUT_FORMAT=${CORTEX_OUTPUT_FORMAT:-yaml}
            - CORTEX_AUTO_SUMMARY_THRESHOLD=${CORTEX_AUTO_SUMMARY_THRESHOLD:-500}

        # Health check configuration
        healthcheck:
            test:
                [
                    'CMD',
                    'wget',
                    '--no-verbose',
                    '--tries=1',
                    '--spider',
                    'http://localhost:3000/health',
                ]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 5s

        # Resource constraints (adjust based on workload)
        deploy:
            resources:
                limits:
                    cpus: '1.0'
                    memory: 512M
                reservations:
                    cpus: '0.25'
                    memory: 128M

# Named volumes for data persistence
volumes:
    cortex-data:
        name: cortex-data
