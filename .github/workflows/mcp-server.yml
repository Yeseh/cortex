name: MCP Server

on:
    push:
        branches: [main]
        paths:
            - 'packages/server/**'
            - 'packages/core/**'
            - 'packages/storage-fs/**'
            - 'package.json'
            - 'bun.lock'
            - 'tsconfig.json'
            - 'eslint.config.js'
            - '.github/workflows/mcp-server.yml'
    pull_request:
        branches: [main]
        paths:
            - 'packages/server/**'
            - 'packages/core/**'
            - 'packages/storage-fs/**'
            - 'package.json'
            - 'bun.lock'
            - 'tsconfig.json'
            - 'eslint.config.js'
            - '.github/workflows/mcp-server.yml'
    workflow_dispatch:

jobs:
    lint:
        name: Lint
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: Run ESLint
              run: bun run lint

    typecheck:
        name: Type Check
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: Run TypeScript type check
              run: bun run typecheck

    test:
        name: Test
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: Run tests
              run: bun test packages/server/

    build:
        name: Build
        runs-on: ubuntu-latest
        needs: [lint, typecheck, test]
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: Compile MCP server binary
              run: bun build --compile --minify --sourcemap --bytecode ./packages/server/src/index.ts --outfile ./bin/cortex-mcp

            - name: Verify binary exists
              run: test -f ./bin/cortex-mcp

            - name: Upload MCP server binary
              uses: actions/upload-artifact@v4
              with:
                  name: cortex-mcp-linux
                  path: ./bin/cortex-mcp
                  retention-days: 7
