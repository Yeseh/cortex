name: CLI

on:
    push:
        branches: [main]
        paths:
            - 'packages/cli/**'
            - 'packages/core/**'
            - 'packages/storage-fs/**'
            - 'package.json'
            - 'bun.lock'
            - 'tsconfig.json'
            - 'eslint.config.js'
            - '.github/workflows/cli.yml'
    pull_request:
        branches: [main]
        paths:
            - 'packages/cli/**'
            - 'packages/core/**'
            - 'packages/storage-fs/**'
            - 'package.json'
            - 'bun.lock'
            - 'tsconfig.json'
            - 'eslint.config.js'
            - '.github/workflows/cli.yml'
    workflow_dispatch:

jobs:
    lint:
        name: Lint
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: Run ESLint
              run: bun run lint

    typecheck:
        name: Type Check
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: Run TypeScript type check
              run: bun run typecheck

    test:
        name: Test
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: Run tests
              run: bun test packages/cli/

            - name: Run acceptance test script
              shell: pwsh
              run: ./scripts/acceptance-test.ps1

    build:
        name: Build
        runs-on: ubuntu-latest
        needs: [lint, typecheck, test]
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: Compile CLI binary
              run: bun build --compile --minify --sourcemap --bytecode ./packages/cli/src/run.ts --outfile ./bin/cortex

            - name: Verify binary exists
              run: test -f ./bin/cortex

            - name: Upload CLI binary
              if: github.event_name == 'push' && github.ref == 'refs/heads/main'
              uses: actions/upload-artifact@v4
              with:
                  name: cortex-cli-linux
                  path: ./bin/cortex
                  retention-days: 7
