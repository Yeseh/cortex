name: Core Library

on:
    push:
        branches: [main]
        paths:
            - 'src/core/**'
            - 'package.json'
            - 'bun.lock'
            - 'tsconfig.json'
            - 'eslint.config.js'
            - '.github/workflows/core.yml'
    pull_request:
        branches: [main]
        paths:
            - 'src/core/**'
            - 'package.json'
            - 'bun.lock'
            - 'tsconfig.json'
            - 'eslint.config.js'
            - '.github/workflows/core.yml'
    workflow_dispatch:

jobs:
    lint:
        name: Lint
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: Run ESLint
              run: bun run eslint src/core/**/*.ts

    typecheck:
        name: Type Check
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: Run TypeScript type check
              run: bun run tsc --noEmit

    test:
        name: Test
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: Run tests
              run: bun test src/core/

    build:
        name: Build
        runs-on: ubuntu-latest
        needs: [lint, typecheck, test]
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Install dependencies
              run: bun install --frozen-lockfile

            - name: Build check (verify compilation)
              run: bun build src/core/index.ts --outdir=dist/core --target=bun
