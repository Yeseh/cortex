import { afterEach, beforeEach, describe, expect, it } from "bun:test";
import { mkdtemp, mkdir, rm } from "node:fs/promises";
import { tmpdir } from "node:os";
import { join, resolve } from "node:path";

import { resolveStore } from "../src/store/store.ts";

describe("store resolution", () => {
  let tempDir: string;
  let cwd: string;
  let globalDir: string;

  beforeEach(async () => {
    tempDir = await mkdtemp(join(tmpdir(), "cortex-store-"));
    cwd = join(tempDir, "project");
    globalDir = join(tempDir, "global");
    await mkdir(cwd, { recursive: true });
    await mkdir(globalDir, { recursive: true });
  });

  afterEach(async () => {
    if (tempDir) {
      await rm(tempDir, { recursive: true, force: true });
    }
  });

  it("should prefer local store when present", async () => {
    const localRoot = join(cwd, ".cortex");
    await mkdir(localRoot, { recursive: true });

    const result = await resolveStore({
      cwd,
      globalStorePath: globalDir,
    });

    expect(result.ok).toBe(true);
    if (result.ok) {
      expect(result.value).toEqual({ root: localRoot, scope: "local" });
    }
  });

  it("should error when strict_local is enabled and local store is missing", async () => {
    const result = await resolveStore({
      cwd,
      globalStorePath: globalDir,
      config: { strict_local: true },
    });

    expect(result.ok).toBe(false);
    if (!result.ok) {
      expect(result.error.code).toBe("LOCAL_STORE_MISSING");
      expect(result.error.path).toBe(resolve(cwd, ".cortex"));
    }
  });

  it("should fallback to the global store when local is missing", async () => {
    const result = await resolveStore({
      cwd,
      globalStorePath: globalDir,
    });

    expect(result.ok).toBe(true);
    if (result.ok) {
      expect(result.value).toEqual({ root: globalDir, scope: "global" });
    }
  });

  it("should resolve relative global paths against cwd", async () => {
    const result = await resolveStore({
      cwd,
      globalStorePath: "../global",
    });

    expect(result.ok).toBe(true);
    if (result.ok) {
      expect(result.value.root).toBe(resolve(cwd, "../global"));
      expect(result.value.scope).toBe("global");
    }
  });
});
